<html>

<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>

<body>
    <div id="position"></div>

    <div id="status">
        HP: <span id="HP"> 5 / 5</span>
    </div>
    <div id="game"></div>
    <br />
    <div id="event_title"></div>
    <div id="event_result"></div>
    <br />
    <div id="battle_result"></div>
    <br />
    <div id="control">
        <button value="1">동</button>
        <button value="3">서</button>
        <button value="2">남</button>
        <button value="0">북</button>
        <button value="5">부활</button>
    </div>

    <script>

        const sendAction = (action, params = {}) => {
            $.ajax({
                url: "/action",
                headers: {
                    Authorization: "Bearer " + key
                },
                method: "POST",
                data: `action=${action}&direction=${params.direction}`,
            }).done((req) => {
                const { player, field, event, battleResult } = req;

                $('#game').text(field.description);
                $('#position').text(`(${field.x},${field.y})`);
                const x = field.x;
                const y = field.y;

                if (battleResult) {
                    alert('! ! ! BATTLE ! ! !');
                    $('button[value="1"]').hide();
                    $('button[value="1"]').unbind('click');
                    $('button[value="2"]').hide();
                    $('button[value="2"]').unbind('click');
                    $('button[value="3"]').hide();
                    $('button[value="3"]').unbind('click');
                    $('button[value="0"]').hide();
                    $('button[value="0"]').unbind('click');
                    $('button[value="5"]').hide();
                    $('button[value="5"]').unbind('click');
                    setTimeout(function () {
                        $('#battle_result').text(battleResult.description);
                        if (!battleResult.win) {
                            $('button[value="5"]').show();
                            $('button[value="5"]').bind('click', function () {
                                sendAction('revive');
                            });
                        } else {
                            field.canGo.forEach((canGo, idx) => {
                                const dom = $(`button[value="${idx}"]`);
                                canGo === 0 ? dom.hide() : dom.show();
                                dom.unbind('click');
                                if (canGo === 1) {
                                    dom.bind('click', function () {
                                        sendAction('move', { direction: idx });
                                    });
                                }
                            })
                            $('button[value="5"]').hide();
                        }
                    }, 3000);
                } else {
                    $('#battle_result').text('');
                    field.canGo.forEach((canGo, idx) => {
                        const dom = $(`button[value="${idx}"]`);
                        canGo === 0 ? dom.hide() : dom.show();
                        dom.unbind('click');
                        if (canGo === 1) {
                            dom.bind('click', function () {
                                sendAction('move', { direction: idx });
                            });
                        }
                    })
                    $('button[value="5"]').hide();
                }

                if (event) {
                    $('#event_title').text(event.title);
                    $('#event_result').text(event.description);
                } else {
                    $('#event_title').text('');
                    $('#event_result').text("아무일도 일어나지 않았다.");
                }

                $('#HP').text(`${player.HP} / ${player.maxHP}`)
            });

        }
        const key = localStorage.getItem('_key');
        if (!key) {
            location.href = "/";
        }

        sendAction("query");



    </script>
</body>

</html>